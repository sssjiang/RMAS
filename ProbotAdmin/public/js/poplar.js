var Poplar = function (n) { var r = {}; function o(e) { if (r[e]) return r[e].exports; var t = r[e] = { i: e, l: !1, exports: {} }; return n[e].call(t.exports, t, t.exports, o), t.l = !0, t.exports } return o.m = n, o.c = r, o.d = function (e, t, n) { o.o(e, t) || Object.defineProperty(e, t, { enumerable: !0, get: n }) }, o.r = function (e) { "undefined" != typeof Symbol && Symbol.toStringTag && Object.defineProperty(e, Symbol.toStringTag, { value: "Module" }), Object.defineProperty(e, "__esModule", { value: !0 }) }, o.t = function (t, e) { if (1 & e && (t = o(t)), 8 & e) return t; if (4 & e && "object" == typeof t && t && t.__esModule) return t; var n = Object.create(null); if (o.r(n), Object.defineProperty(n, "default", { enumerable: !0, value: t }), 2 & e && "string" != typeof t) for (var r in t) o.d(n, r, function (e) { return t[e] }.bind(null, r)); return n }, o.n = function (e) { var t = e && e.__esModule ? function () { return e.default } : function () { return e }; return o.d(t, "a", t), t }, o.o = function (e, t) { return Object.prototype.hasOwnProperty.call(e, t) }, o.p = "", o(o.s = 12) }([function (e, t, n) { "use strict"; Object.defineProperty(t, "__esModule", { value: !0 }), t.SVGNS = "http://www.w3.org/2000/svg" }, function (e, t, n) { "use strict"; var r, o = this && this.__extends || (r = function (e, t) { return (r = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function (e, t) { e.__proto__ = t } || function (e, t) { for (var n in t) t.hasOwnProperty(n) && (e[n] = t[n]) })(e, t) }, function (e, t) { function n() { this.constructor = e } r(e, t), e.prototype = null === t ? Object.create(t) : (n.prototype = t.prototype, new n) }), s = this && this.__values || function (e) { var t = "function" == typeof Symbol && Symbol.iterator, n = t && e[t], r = 0; if (n) return n.call(e); if (e && "number" == typeof e.length) return { next: function () { return e && r >= e.length && (e = void 0), { value: e && e[r++], done: !e } } }; throw new TypeError(t ? "Object is not iterable." : "Symbol.iterator is not defined.") }; Object.defineProperty(t, "__esModule", { value: !0 }); var i, a, l, c = n(4), u = n(3); function h() { var e = null !== a && a.apply(this, arguments) || this; return e.entities = new Map, e.nextId = 0, e } i = t.Base || (t.Base = {}), a = u.EventEmitter, o(h, a), Object.defineProperty(h.prototype, "json", { get: function () { var t, e, n = []; try { for (var r = s(this.values()), o = r.next(); !o.done; o = r.next()) { var i = o.value; "json" in i ? n.push(i.json) : n.push(JSON.parse(JSON.stringify(i))) } } catch (e) { t = { error: e } } finally { try { o && !o.done && (e = r.return) && e.call(r) } finally { if (t) throw t.error } } return n }, enumerable: !0, configurable: !0 }), Object.defineProperty(h.prototype, "length", { get: function () { return this.entities.size }, enumerable: !0, configurable: !0 }), h.prototype.get = function (e) { return c.assert(this.has(e), "There's no Entity which id=" + e + " in repo!"), this.entities.get(e) }, h.prototype.has = function (e) { return this.entities.has(e) }, h.prototype.set = function (e, t) { var n = this.has(e); return this.entities.set(e, t), n ? this.emit("updated", t) : (this.nextId < e + 1 && (this.nextId = e + 1), this.emit("created", t)), this }, h.prototype.add = function (e) { if ("id" in e) { var t = e.id; return c.assert(!this.has(t), "reAdd " + t + "!"), null === t ? (e.id = this.nextId, this.add(e)) : (this.set(t, e), t) } var n = this.nextId; return this.set(n, e), n }, h.prototype[Symbol.iterator] = function () { return this.entities[Symbol.iterator]() }, h.prototype.delete = function (e) { if ("number" == typeof e && this.has(e)) { var t = this.get(e); return this.entities.delete(e), this.emit("removed", t), !0 } return "number" != typeof e && "id" in e && this.delete(e.id) }, h.prototype.values = function () { return this.entities.values() }, l = h, i.Repository = l }, function (e, t, n) { "use strict"; Object.defineProperty(t, "__esModule", { value: !0 }); var r = (Object.defineProperty(o.prototype, "isSome", { get: function () { return null !== this.value }, enumerable: !0, configurable: !0 }), o.prototype.map = function (e) { return null === this.value ? new o(null) : new o(e(this.value)) }, o.prototype.flatMap = function (e) { return null === this.value ? new o(null) : s(e(this.value).toNullable()) }, o.prototype.orElse = function (e) { return null === this.value ? e : this.value }, o.prototype.toNullable = function () { return this.value }, o.prototype.match = function (e, t) { return this.isSome ? e : t }, o); function o(e) { this.value = e } function i(e) { return new r(e) } function s(e) { return null == e ? t.none : i(e) } t.Option = r, t.none = new r(null), t.some = i, t.fromNullable = s, t.fromTry = function (e) { try { return i(e()) } catch (e) { return t.none } } }, function (e, t, n) { "use strict"; var r, o = "object" == typeof Reflect ? Reflect : null, u = o && "function" == typeof o.apply ? o.apply : function (e, t, n) { return Function.prototype.apply.call(e, t, n) }; r = o && "function" == typeof o.ownKeys ? o.ownKeys : Object.getOwnPropertySymbols ? function (e) { return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e)) } : function (e) { return Object.getOwnPropertyNames(e) }; var i = Number.isNaN || function (e) { return e != e }; function s() { s.init.call(this) } ((e.exports = s).EventEmitter = s).prototype._events = void 0, s.prototype._eventsCount = 0, s.prototype._maxListeners = void 0; var a = 10; function c(e) { if ("function" != typeof e) throw new TypeError('The "listener" argument must be of type Function. Received type ' + typeof e) } function h(e) { return void 0 === e._maxListeners ? s.defaultMaxListeners : e._maxListeners } function l(e, t, n, r) { var o, i, s, a; if (c(n), void 0 === (i = e._events) ? (i = e._events = Object.create(null), e._eventsCount = 0) : (void 0 !== i.newListener && (e.emit("newListener", t, n.listener ? n.listener : n), i = e._events), s = i[t]), void 0 === s) s = i[t] = n, ++e._eventsCount; else if ("function" == typeof s ? s = i[t] = r ? [n, s] : [s, n] : r ? s.unshift(n) : s.push(n), 0 < (o = h(e)) && s.length > o && !s.warned) { s.warned = !0; var l = new Error("Possible EventEmitter memory leak detected. " + s.length + " " + String(t) + " listeners added. Use emitter.setMaxListeners() to increase limit"); l.name = "MaxListenersExceededWarning", l.emitter = e, l.type = t, l.count = s.length, a = l, console && console.warn && console.warn(a) } return e } function d(e, t, n) { var r = { fired: !1, wrapFn: void 0, target: e, type: t, listener: n }, o = function () { if (!this.fired) return this.target.removeListener(this.type, this.wrapFn), this.fired = !0, 0 === arguments.length ? this.listener.call(this.target) : this.listener.apply(this.target, arguments) }.bind(r); return o.listener = n, r.wrapFn = o } function f(e, t, n) { var r = e._events; if (void 0 === r) return []; var o = r[t]; return void 0 === o ? [] : "function" == typeof o ? n ? [o.listener || o] : [o] : n ? function (e) { for (var t = new Array(e.length), n = 0; n < t.length; ++n)t[n] = e[n].listener || e[n]; return t }(o) : y(o, o.length) } function p(e) { var t = this._events; if (void 0 !== t) { var n = t[e]; if ("function" == typeof n) return 1; if (void 0 !== n) return n.length } return 0 } function y(e, t) { for (var n = new Array(t), r = 0; r < t; ++r)n[r] = e[r]; return n } Object.defineProperty(s, "defaultMaxListeners", { enumerable: !0, get: function () { return a }, set: function (e) { if ("number" != typeof e || e < 0 || i(e)) throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received ' + e + "."); a = e } }), s.init = function () { void 0 !== this._events && this._events !== Object.getPrototypeOf(this)._events || (this._events = Object.create(null), this._eventsCount = 0), this._maxListeners = this._maxListeners || void 0 }, s.prototype.setMaxListeners = function (e) { if ("number" != typeof e || e < 0 || i(e)) throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received ' + e + "."); return this._maxListeners = e, this }, s.prototype.getMaxListeners = function () { return h(this) }, s.prototype.emit = function (e) { for (var t = [], n = 1; n < arguments.length; n++)t.push(arguments[n]); var r = "error" === e, o = this._events; if (void 0 !== o) r = r && void 0 === o.error; else if (!r) return !1; if (r) { var i; if (0 < t.length && (i = t[0]), i instanceof Error) throw i; var s = new Error("Unhandled error." + (i ? " (" + i.message + ")" : "")); throw s.context = i, s } var a = o[e]; if (void 0 === a) return !1; if ("function" == typeof a) u(a, this, t); else { var l = a.length, c = y(a, l); for (n = 0; n < l; ++n)u(c[n], this, t) } return !0 }, s.prototype.on = s.prototype.addListener = function (e, t) { return l(this, e, t, !1) }, s.prototype.prependListener = function (e, t) { return l(this, e, t, !0) }, s.prototype.once = function (e, t) { return c(t), this.on(e, d(this, e, t)), this }, s.prototype.prependOnceListener = function (e, t) { return c(t), this.prependListener(e, d(this, e, t)), this }, s.prototype.off = s.prototype.removeListener = function (e, t) { var n, r, o, i, s; if (c(t), void 0 === (r = this._events)) return this; if (void 0 === (n = r[e])) return this; if (n === t || n.listener === t) 0 == --this._eventsCount ? this._events = Object.create(null) : (delete r[e], r.removeListener && this.emit("removeListener", e, n.listener || t)); else if ("function" != typeof n) { for (o = -1, i = n.length - 1; 0 <= i; i--)if (n[i] === t || n[i].listener === t) { s = n[i].listener, o = i; break } if (o < 0) return this; 0 === o ? n.shift() : function (e, t) { for (; t + 1 < e.length; t++)e[t] = e[t + 1]; e.pop() }(n, o), 1 === n.length && (r[e] = n[0]), void 0 !== r.removeListener && this.emit("removeListener", e, s || t) } return this }, s.prototype.removeAllListeners = function (e) { var t, n, r; if (void 0 === (n = this._events)) return this; if (void 0 === n.removeListener) return 0 === arguments.length ? (this._events = Object.create(null), this._eventsCount = 0) : void 0 !== n[e] && (0 == --this._eventsCount ? this._events = Object.create(null) : delete n[e]), this; if (0 === arguments.length) { var o, i = Object.keys(n); for (r = 0; r < i.length; ++r)"removeListener" !== (o = i[r]) && this.removeAllListeners(o); return this.removeAllListeners("removeListener"), this._events = Object.create(null), this._eventsCount = 0, this } if ("function" == typeof (t = n[e])) this.removeListener(e, t); else if (void 0 !== t) for (r = t.length - 1; 0 <= r; r--)this.removeListener(e, t[r]); return this }, s.prototype.listeners = function (e) { return f(this, e, !0) }, s.prototype.rawListeners = function (e) { return f(this, e, !1) }, s.listenerCount = function (e, t) { return "function" == typeof e.listenerCount ? e.listenerCount(t) : p.call(e, t) }, s.prototype.listenerCount = p, s.prototype.eventNames = function () { return 0 < this._eventsCount ? r(this._events) : [] } }, function (e, t, n) { "use strict"; Object.defineProperty(t, "__esModule", { value: !0 }), t.assert = function (e, t) { 0 } }, function (e, t, n) { "use strict"; Object.defineProperty(t, "__esModule", { value: !0 }), t.shadeColor = function (e, t) { var n = parseInt(e.slice(1), 16), r = Math.min((n >> 16) + (n >> 16) * t / 100, 255), o = Math.min((n >> 8 & 255) + (n >> 8 & 255) * t / 100, 255); return "#" + (Math.min((255 & n) + (255 & n) * t / 100, 255) | o << 8 | r << 16).toString(16) }, t.addAlpha = function (e, t) { var n = parseInt(e.slice(1), 16); return "rgba(" + (n >> 16) + "," + (n >> 8 & 255) + "," + (255 & n) + "," + t + "%)" } }, function (e, t, n) { "use strict"; Object.defineProperty(t, "__esModule", { value: !0 }); function r() { this.layer = 0 } t.TopContextUser = r, t.overLaps = function e(t, n) { return t.layer === n.layer && (t.left > n.left ? e(n, t) : !(t.left + t.width < n.left)) } }, function (e, t, n) { "use strict"; var r, a = this && this.__extends || (r = function (e, t) { return (r = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function (e, t) { e.__proto__ = t } || function (e, t) { for (var n in t) t.hasOwnProperty(n) && (e[n] = t[n]) })(e, t) }, function (e, t) { function n() { this.constructor = e } r(e, t), e.prototype = null === t ? Object.create(t) : (n.prototype = t.prototype, new n) }), o = this && this.__read || function (e, t) { var n = "function" == typeof Symbol && e[Symbol.iterator]; if (!n) return e; var r, o, i = n.call(e), s = []; try { for (; (void 0 === t || 0 < t--) && !(r = i.next()).done;)s.push(r.value) } catch (e) { o = { error: e } } finally { try { r && !r.done && (n = i.return) && n.call(i) } finally { if (o) throw o.error } } return s }, l = this && this.__spread || function () { for (var e = [], t = 0; t < arguments.length; t++)e = e.concat(o(arguments[t])); return e }; Object.defineProperty(t, "__esModule", { value: !0 }); var c = n(6), x = n(0), u = n(1), h = n(5); !function (e) { var o, t = (o = c.TopContextUser, a(n, o), Object.defineProperty(n.prototype, "id", { get: function () { return this.store.id }, enumerable: !0, configurable: !0 }), Object.defineProperty(n.prototype, "lineIn", { get: function () { return this.contextIn.belongTo }, enumerable: !0, configurable: !0 }), Object.defineProperty(n.prototype, "view", { get: function () { return this.lineIn.view }, enumerable: !0, configurable: !0 }), Object.defineProperty(n.prototype, "highLightWidth", { get: function () { return this.view.contentWidth(this.store.startIndex, this.store.endIndex) }, enumerable: !0, configurable: !0 }), Object.defineProperty(n.prototype, "highLightLeft", { get: function () { return this.view.contentWidth(this.lineIn.startIndex, this.store.startIndex) + this.lineIn.view.paddingLeft }, enumerable: !0, configurable: !0 }), Object.defineProperty(n.prototype, "middle", { get: function () { return this.highLightLeft + this.highLightWidth / 2 }, enumerable: !0, configurable: !0 }), Object.defineProperty(n.prototype, "labelLeft", { get: function () { return this.middle - this.labelWidth / 2 }, enumerable: !0, configurable: !0 }), Object.defineProperty(n.prototype, "labelRight", { get: function () { return this.middle + this.labelWidth / 2 }, enumerable: !0, configurable: !0 }), Object.defineProperty(n.prototype, "labelWidth", { get: function () { return this.view.labelFont.widthOf(this.store.category.text) + this.config.labelPadding + 2 }, enumerable: !0, configurable: !0 }), Object.defineProperty(n.prototype, "left", { get: function () { return "max" !== this.config.labelWidthCalcMethod || this.labelWidth > this.highLightWidth ? this.labelLeft : this.highLightLeft }, enumerable: !0, configurable: !0 }), Object.defineProperty(n.prototype, "width", { get: function () { return "max" !== this.config.labelWidthCalcMethod || this.labelWidth > this.highLightWidth - 1 ? this.labelWidth : this.highLightWidth - 1 }, enumerable: !0, configurable: !0 }), Object.defineProperty(n.prototype, "annotationY", { get: function () { return -this.view.topContextLayerHeight * (this.layer - 1) - (this.view.labelFont.lineHeight + 2 + 2 * this.config.labelPadding + this.config.bracketWidth) }, enumerable: !0, configurable: !0 }), Object.defineProperty(n.prototype, "globalY", { get: function () { return this.lineIn.y + this.annotationY }, enumerable: !0, configurable: !0 }), n.prototype.render = function () { var e; this.svgElement = document.createElementNS(x.SVGNS, "g"), (e = this.svgElement.classList).add.apply(e, l(this.config.labelClasses)); var t = this.createHighLightElement(), n = this.createAnnotationElement(), r = this.view.topContextLayerHeight * (this.layer - 1), o = this.createBracketElement(this.highLightWidth, -r, 0, -r, this.config.bracketWidth); return this.svgElement.appendChild(t), this.svgElement.appendChild(n), this.svgElement.appendChild(o), this.svgElement }, n.prototype.update = function () { this.svgElement.style.transform = "translate(" + this.highLightLeft + "px," + this.lineIn.y + "px)" }, n.prototype.remove = function () { this.svgElement.remove() }, n.prototype.createHighLightElement = function () { var e = document.createElementNS(x.SVGNS, "rect"), t = this.store.category.color; return e.setAttribute("height", this.lineIn.view.contentFont.lineHeight.toString()), e.setAttribute("width", this.highLightWidth.toString()), e.setAttribute("fill", /^#/g.test(t) ? h.addAlpha(t, 70) : t), e }, n.prototype.createBracketElement = function (e, t, n, r, o, i) { void 0 === i && (i = .6); var s = e - n, a = t - r, l = Math.sqrt(s * s + a * a), c = e + i * o * (a /= l), u = t - i * o * (s /= l), h = e - .25 * l * s + (1 - i) * o * a, d = t - .25 * l * a - (1 - i) * o * s, f = e - .5 * l * s + o * a, p = t - .5 * l * a - o * s, y = n + i * o * a, v = r - i * o * s, m = e - .75 * l * s + (1 - i) * o * a, b = t - .75 * l * a - (1 - i) * o * s, g = document.createElementNS(x.SVGNS, "path"); return g.setAttribute("d", "M" + e + "," + t + "Q" + c + "," + u + "," + h + "," + d + "T" + f + "," + p + "M" + n + "," + r + "Q" + y + "," + v + "," + m + "," + b + "T" + f + "," + p), g.setAttribute("fill", "none"), g.setAttribute("stroke", this.store.category.borderColor), g }, n.prototype.createAnnotationElement = function () { var t = this, e = this.view.labelCategoryElementFactoryRepository.get(this.store.category.id).create(); return e.style.transform = "translate(" + (this.highLightWidth - this.labelWidth) / 2 + "px," + this.annotationY + "px)", e.onclick = function (e) { t.view.root.emit("labelClicked", t.id, e) }, e.ondblclick = function (e) { t.view.root.emit("labelDoubleClicked", t.id, e) }, e.oncontextmenu = function (e) { t.view.root.emit("labelRightClicked", t.id, e), e.preventDefault() }, e.onmouseenter = function () { t.svgElement.classList.add("hover"), Array.from(t.store.connectionsFrom).map(function (e) { return t.view.connectionViewRepository.get(e.id) }).map(function (e) { return e.addHover("from") }), Array.from(t.store.connectionsTo).map(function (e) { return t.view.connectionViewRepository.get(e.id) }).map(function (e) { return e.addHover("to") }) }, e.onmouseleave = function () { t.svgElement.classList.remove("hover"), Array.from(t.store.connectionsFrom).map(function (e) { return t.view.connectionViewRepository.get(e.id) }).map(function (e) { return e.removeHover("from") }), Array.from(t.store.connectionsTo).map(function (e) { return t.view.connectionViewRepository.get(e.id) }).map(function (e) { return e.removeHover("to") }) }, e }, n); function n(e, t, n) { var r = o.call(this) || this; return r.store = e, r.contextIn = t, r.config = n, r.layer = 0, r.svgElement = null, r } e.Entity = t; var r, i = (r = u.Base.Repository, a(s, r), s.prototype.get = function (e) { return this.entities.get(e) }, s); function s() { return null !== r && r.apply(this, arguments) || this } e.Repository = i }(t.LabelView || (t.LabelView = {})) }, function (e, t, n) { "use strict"; var r, l = this && this.__extends || (r = function (e, t) { return (r = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function (e, t) { e.__proto__ = t } || function (e, t) { for (var n in t) t.hasOwnProperty(n) && (e[n] = t[n]) })(e, t) }, function (e, t) { function n() { this.constructor = e } r(e, t), e.prototype = null === t ? Object.create(t) : (n.prototype = t.prototype, new n) }), c = this && this.__values || function (e) { var t = "function" == typeof Symbol && Symbol.iterator, n = t && e[t], r = 0; if (n) return n.call(e); if (e && "number" == typeof e.length) return { next: function () { return e && r >= e.length && (e = void 0), { value: e && e[r++], done: !e } } }; throw new TypeError(t ? "Object is not iterable." : "Symbol.iterator is not defined.") }; Object.defineProperty(t, "__esModule", { value: !0 }); var u = n(1); !function (e) { var n = (Object.defineProperty(t.prototype, "startIndex", { get: function () { return this._startIndex }, enumerable: !0, configurable: !0 }), Object.defineProperty(t.prototype, "endIndex", { get: function () { return this._endIndex }, enumerable: !0, configurable: !0 }), t.prototype.move = function (e) { this._startIndex += e, this._endIndex += e }, Object.defineProperty(t.prototype, "category", { get: function () { return this.root.labelCategoryRepo.get(this.categoryId) }, enumerable: !0, configurable: !0 }), Object.defineProperty(t.prototype, "json", { get: function () { return { id: this.id, categoryId: this.categoryId, startIndex: this.startIndex, endIndex: this.endIndex } }, enumerable: !0, configurable: !0 }), Object.defineProperty(t.prototype, "sameLineConnections", { get: function () { var t, e, n = []; try { for (var r = c(this.root.connectionRepo.values()), o = r.next(); !o.done; o = r.next()) { var i = o.value; i.priorLabel === this && n.push(i) } } catch (e) { t = { error: e } } finally { try { o && !o.done && (e = r.return) && e.call(r) } finally { if (t) throw t.error } } return n }, enumerable: !0, configurable: !0 }), Object.defineProperty(t.prototype, "connectionsFrom", { get: function () { var t, e, n = new Set; try { for (var r = c(this.root.connectionRepo.values()), o = r.next(); !o.done; o = r.next()) { var i = o.value; i.from === this && n.add(i) } } catch (e) { t = { error: e } } finally { try { o && !o.done && (e = r.return) && e.call(r) } finally { if (t) throw t.error } } return n }, enumerable: !0, configurable: !0 }), Object.defineProperty(t.prototype, "connectionsTo", { get: function () { var t, e, n = new Set; try { for (var r = c(this.root.connectionRepo.values()), o = r.next(); !o.done; o = r.next()) { var i = o.value; i.to === this && n.add(i) } } catch (e) { t = { error: e } } finally { try { o && !o.done && (e = r.return) && e.call(r) } finally { if (t) throw t.error } } return n }, enumerable: !0, configurable: !0 }), Object.defineProperty(t.prototype, "allConnections", { get: function () { return new Set(Array.prototype.concat(Array.from(this.connectionsFrom), Array.from(this.connectionsTo))) }, enumerable: !0, configurable: !0 }), t); function t(e, t, n, r, o) { this.id = e, this.categoryId = t, this._startIndex = n, this._endIndex = r, this.root = o } e.Entity = n; var r, o, i = (r = u.Base.Repository, l(s, r), s.prototype.set = function (e, t) { return this.againstMultipleLabelWith(t) ? console.warn("try set a label against the againstMultipleLabelWith rule!") : r.prototype.set.call(this, e, t), this }, s.prototype.add = function (e) { return this.againstMultipleLabelWith(e) ? (console.warn("try add a label against the againstMultipleLabelWith rule!"), -1) : r.prototype.add.call(this, e) }, s.prototype.againstMultipleLabelWith = function (t) { function n(e, t) { return e.startIndex === t.startIndex && e.endIndex === t.endIndex } var r = "notAllowed" === this.config.allowMultipleLabel ? n : function (e, t) { return n(e, t) && e.categoryId == t.categoryId }; return Array.from(this.values()).some(function (e) { return r(e, t) }) }, s.prototype.getEntitiesInRange = function (t, n) { return Array.from(this.entities.values()).filter(function (e) { return t <= e.startIndex && e.endIndex <= n }) }, s.prototype.getEntitiesCross = function (t) { return Array.from(this.entities.values()).filter(function (e) { return e.startIndex <= t && t < e.endIndex }) }, s); function s(e) { var t = r.call(this) || this; return t.config = e, t } function a(e, t) { return new n(e.id, e.categoryId, e.startIndex, e.endIndex, t) } e.Repository = i, (o = e.Factory || (e.Factory = {})).create = a, o.createAll = function (e, t) { return e.map(function (e) { return a(e, t) }) } }(t.Label || (t.Label = {})) }, function (e, t, n) { "use strict"; var r, l = this && this.__extends || (r = function (e, t) { return (r = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function (e, t) { e.__proto__ = t } || function (e, t) { for (var n in t) t.hasOwnProperty(n) && (e[n] = t[n]) })(e, t) }, function (e, t) { function n() { this.constructor = e } r(e, t), e.prototype = null === t ? Object.create(t) : (n.prototype = t.prototype, new n) }); Object.defineProperty(t, "__esModule", { value: !0 }); var c = n(1); !function (e) { var n = (Object.defineProperty(t.prototype, "category", { get: function () { return this.root.connectionCategoryRepo.get(this.categoryId) }, enumerable: !0, configurable: !0 }), Object.defineProperty(t.prototype, "from", { get: function () { return this.root.labelRepo.get(this.fromId) }, enumerable: !0, configurable: !0 }), Object.defineProperty(t.prototype, "to", { get: function () { return this.root.labelRepo.get(this.toId) }, enumerable: !0, configurable: !0 }), Object.defineProperty(t.prototype, "priorLabel", { get: function () { return this.from.startIndex < this.to.startIndex ? this.from : this.to }, enumerable: !0, configurable: !0 }), Object.defineProperty(t.prototype, "posteriorLabel", { get: function () { return this.from.startIndex >= this.to.startIndex ? this.from : this.to }, enumerable: !0, configurable: !0 }), Object.defineProperty(t.prototype, "json", { get: function () { return { id: this.id, categoryId: this.categoryId, fromId: this.fromId, toId: this.toId } }, enumerable: !0, configurable: !0 }), t); function t(e, t, n, r, o) { this.id = e, this.categoryId = t, this.fromId = n, this.toId = r, this.root = o } e.Entity = n; var r, o, i = (r = c.Base.Repository, l(s, r), s.prototype.set = function (e, t) { return this.againstMultipleConnectionRuleWith(t) ? console.warn("try set a label against the checkMultipleLabel rule!") : r.prototype.set.call(this, e, t), this }, s.prototype.add = function (e) { return this.againstMultipleConnectionRuleWith(e) ? (console.warn("try add a label against the checkMultipleLabel rule!"), -1) : r.prototype.add.call(this, e) }, s.prototype.againstMultipleConnectionRuleWith = function (t) { function n(e, t) { return e.from === t.from && e.to === t.to } var r = "notAllowed" === this.config.allowMultipleConnection ? n : function (e, t) { return n(e, t) && e.categoryId == t.categoryId }; return Array.from(this.values()).some(function (e) { return r(e, t) }) }, s); function s(e) { var t = r.call(this) || this; return t.config = e, t } function a(e, t) { return new n(e.id, e.categoryId, e.fromId, e.toId, t) } e.Repository = i, (o = e.Factory || (e.Factory = {})).create = a, o.createAll = function (e, t) { return e.map(function (e) { return a(e, t) }) } }(t.Connection || (t.Connection = {})) }, function (e, t, n) { "use strict"; var r, a = this && this.__extends || (r = function (e, t) { return (r = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function (e, t) { e.__proto__ = t } || function (e, t) { for (var n in t) t.hasOwnProperty(n) && (e[n] = t[n]) })(e, t) }, function (e, t) { function n() { this.constructor = e } r(e, t), e.prototype = null === t ? Object.create(t) : (n.prototype = t.prototype, new n) }), o = this && this.__read || function (e, t) { var n = "function" == typeof Symbol && e[Symbol.iterator]; if (!n) return e; var r, o, i = n.call(e), s = []; try { for (; (void 0 === t || 0 < t--) && !(r = i.next()).done;)s.push(r.value) } catch (e) { o = { error: e } } finally { try { r && !r.done && (n = i.return) && n.call(i) } finally { if (o) throw o.error } } return s }, l = this && this.__spread || function () { for (var e = [], t = 0; t < arguments.length; t++)e = e.concat(o(arguments[t])); return e }; Object.defineProperty(t, "__esModule", { value: !0 }); var c = n(1), u = n(0), h = n(6); !function (e) { var o, t = (o = h.TopContextUser, a(n, o), Object.defineProperty(n.prototype, "id", { get: function () { return this.store.id }, enumerable: !0, configurable: !0 }), Object.defineProperty(n.prototype, "lineIn", { get: function () { return this.contextIn.belongTo }, enumerable: !0, configurable: !0 }), Object.defineProperty(n.prototype, "view", { get: function () { return this.lineIn.view }, enumerable: !0, configurable: !0 }), Object.defineProperty(n.prototype, "sameLineLabelView", { get: function () { return this.view.labelViewRepository.get(this.store.priorLabel.id) }, enumerable: !0, configurable: !0 }), Object.defineProperty(n.prototype, "mayNotSameLineLabelView", { get: function () { return this.view.labelViewRepository.get(this.store.posteriorLabel.id) }, enumerable: !0, configurable: !0 }), Object.defineProperty(n.prototype, "fromLabelView", { get: function () { return this.view.labelViewRepository.get(this.store.from.id) }, enumerable: !0, configurable: !0 }), Object.defineProperty(n.prototype, "toLabelView", { get: function () { return this.view.labelViewRepository.get(this.store.to.id) }, enumerable: !0, configurable: !0 }), Object.defineProperty(n.prototype, "leftLabelView", { get: function () { return this.fromLabelView.labelLeft < this.toLabelView.labelLeft ? this.fromLabelView : this.toLabelView }, enumerable: !0, configurable: !0 }), Object.defineProperty(n.prototype, "rightLabelView", { get: function () { return this.fromLabelView.labelLeft >= this.toLabelView.labelLeft ? this.fromLabelView : this.toLabelView }, enumerable: !0, configurable: !0 }), Object.defineProperty(n.prototype, "middle", { get: function () { return (this.leftLabelView.labelLeft + this.rightLabelView.labelRight) / 2 }, enumerable: !0, configurable: !0 }), Object.defineProperty(n.prototype, "textWidth", { get: function () { return this.view.connectionFont.widthOf(this.store.category.text) }, enumerable: !0, configurable: !0 }), Object.defineProperty(n.prototype, "textLeft", { get: function () { return this.middle - this.textWidth / 2 }, enumerable: !0, configurable: !0 }), Object.defineProperty(n.prototype, "lineIncludedWidth", { get: function () { return this.fromLabelView.labelLeft < this.toLabelView.labelLeft ? this.toLabelView.labelRight - this.fromLabelView.labelLeft : this.fromLabelView.labelRight - this.toLabelView.labelLeft }, enumerable: !0, configurable: !0 }), Object.defineProperty(n.prototype, "lineIncludedLeft", { get: function () { return this.fromLabelView.labelLeft < this.toLabelView.labelLeft ? this.fromLabelView.labelLeft : this.toLabelView.labelLeft }, enumerable: !0, configurable: !0 }), Object.defineProperty(n.prototype, "width", { get: function () { return "text" === this.config.connectionWidthCalcMethod ? this.textWidth : this.lineIncludedWidth }, enumerable: !0, configurable: !0 }), Object.defineProperty(n.prototype, "left", { get: function () { return "text" === this.config.connectionWidthCalcMethod ? this.textLeft : this.lineIncludedLeft }, enumerable: !0, configurable: !0 }), Object.defineProperty(n.prototype, "globalY", { get: function () { return this.lineIn.y - this.layer * this.view.topContextLayerHeight }, enumerable: !0, configurable: !0 }), n.prototype.render = function () { var t = this; this.svgElement = document.createElementNS(u.SVGNS, "g"); var e = this.view.connectionCategoryElementFactoryRepository.get(this.store.category.id).create(); return this.svgElement.appendChild(e), this.svgElement.style.cursor = "pointer", this.svgElement.onclick = function (e) { t.view.root.emit("connectionClicked", t.id, e) }, this.svgElement.ondblclick = function (e) { t.view.root.emit("connectionDoubleClicked", t.id, e) }, this.svgElement.oncontextmenu = function (e) { t.view.root.emit("connectionRightClicked", t.id, e), e.preventDefault() }, this.svgElement.onmouseenter = function () { t.svgElement.classList.add("hover"), t.lineElement.classList.add("hover") }, this.svgElement.onmouseleave = function () { t.svgElement.classList.remove("hover"), t.lineElement.classList.remove("hover") }, this.renderLine(), this.svgElement }, n.prototype.update = function () { this.svgElement && (this.svgElement.style.transform = "translate(" + this.textLeft + "px," + this.globalY + "px)", this.updateLine()) }, n.prototype.addHover = function (e) { this.svgElement.classList.add("hover-" + e), this.lineElement.classList.add("hover-" + e) }, n.prototype.removeHover = function (e) { this.svgElement.classList.remove("hover-" + e), this.lineElement.classList.remove("hover-" + e) }, n.prototype.remove = function () { this.svgElement.remove(), this.lineElement.remove() }, n.prototype.updateLine = function () { var e = this.globalY + this.view.topContextLayerHeight / 2 - this.view.labelFont.fontSize + 2; this.fromLabelView.labelLeft < this.toLabelView.labelLeft ? this.lineElement.setAttribute("d", "\n                    M " + (this.fromLabelView.labelLeft + 1) + "   " + (this.fromLabelView.globalY + 1) + "\n                    C " + (this.fromLabelView.labelLeft - 8) + "  " + e + ",\n                      " + (this.fromLabelView.labelLeft - 8) + "  " + e + ",\n                      " + (this.fromLabelView.labelLeft + 1) + "   " + e + "\n                    L " + (this.toLabelView.labelLeft + this.toLabelView.labelWidth) + " " + e + "\n                    C " + (this.toLabelView.labelLeft + this.toLabelView.labelWidth + 8) + "  " + e + ",\n                      " + (this.toLabelView.labelLeft + this.toLabelView.labelWidth + 8) + "  " + e + ",\n                      " + (this.toLabelView.labelLeft + this.toLabelView.labelWidth) + "   " + (this.toLabelView.globalY - 1) + "\n                ") : this.lineElement.setAttribute("d", "\n                    M " + (this.fromLabelView.labelRight - 1) + "   " + (this.fromLabelView.globalY + 1) + "\n                    C " + (this.fromLabelView.labelRight + 8) + "  " + e + ",\n                      " + (this.fromLabelView.labelRight + 8) + "  " + e + ",\n                      " + (this.fromLabelView.labelRight - 1) + "   " + e + "\n                    L " + this.toLabelView.labelLeft + "          " + e + "\n                    C " + (this.toLabelView.labelLeft - 8) + "  " + e + ",\n                      " + (this.toLabelView.labelLeft - 8) + "  " + e + ",\n                      " + this.toLabelView.labelLeft + "   " + (this.toLabelView.globalY - 1) + "\n                ") }, n.prototype.renderLine = function () { var e; this.lineElement = document.createElementNS(u.SVGNS, "path"), (e = this.lineElement.classList).add.apply(e, l(this.config.connectionClasses.map(function (e) { return e + "-line" }))), this.lineElement.setAttribute("fill", "none"), this.lineElement.style.markerEnd = "url(#marker-arrow)", this.updateLine(), this.contextIn.backgroundElement.appendChild(this.lineElement) }, n); function n(e, t, n) { var r = o.call(this) || this; return r.store = e, r.contextIn = t, r.config = n, r.svgElement = null, r.lineElement = null, r } e.Entity = t; var r, i = (r = c.Base.Repository, a(s, r), s); function s() { return null !== r && r.apply(this, arguments) || this } e.Repository = i }(t.ConnectionView || (t.ConnectionView = {})) }, function (e, t, n) { "use strict"; var r = this && this.__read || function (e, t) { var n = "function" == typeof Symbol && e[Symbol.iterator]; if (!n) return e; var r, o, i = n.call(e), s = []; try { for (; (void 0 === t || 0 < t--) && !(r = i.next()).done;)s.push(r.value) } catch (e) { o = { error: e } } finally { try { r && !r.done && (n = i.return) && n.call(i) } finally { if (o) throw o.error } } return s }, l = this && this.__spread || function () { for (var e = [], t = 0; t < arguments.length; t++)e = e.concat(r(arguments[t])); return e }; Object.defineProperty(t, "__esModule", { value: !0 }); var o, h, c = n(0); function i(e, t, n, r, o, i) { this.fontFamily = e, this.fontSize = t, this.fontWeight = n, this.lineHeight = r, this.topToBaseLine = o, this.width = i } o = t.Font || (t.Font = {}), i.prototype.widthOf = function (e) { var t = this; return "string" == typeof e ? this.widthOf(Array.from(e)) : e.map(function (e) { return t.width.get(e) }).reduce(function (e, t) { return e + t }, 0) }, h = i, o.ValueObject = h, function (e) { function i(e, n, t) { var r = new Map, o = new Set(e); o.delete("\n"); var i = Array.from(o); n.textContent = i.join(""), n.parentNode.parentNode.insertBefore(t, n.parentNode), i.forEach(function (e, t) { r.set(e, n.getExtentOfChar(t).width) }); var s = t.getBoundingClientRect().top - n.getBoundingClientRect().top, a = parseFloat(window.getComputedStyle(n).fontSize), l = window.getComputedStyle(n).fontFamily, c = window.getComputedStyle(n).fontWeight, u = n.getBoundingClientRect().height; return new h(l, a, c, u, s, r) } e.create = i; var n = (t.prototype.thanCreate = function (e, t) { var n, r; (n = this.measuringElement.classList).add.apply(n, l(e)); var o = i(t, this.measuringElement, this.baseLineReferenceElement); return (r = this.measuringElement.classList).remove.apply(r, l(e)), this.result.push(o), this }, t.prototype.endBatch = function () { return this.baseLineReferenceElement.remove(), this.measuringElement.remove(), this.result }, t); function t(e, t) { this.svgElement = e, this.textElement = t, this.baseLineReferenceElement = document.createElementNS(c.SVGNS, "rect"), this.baseLineReferenceElement.setAttribute("width", "1px"), this.baseLineReferenceElement.setAttribute("height", "1px"), this.svgElement.appendChild(this.baseLineReferenceElement), this.measuringElement = document.createElementNS(c.SVGNS, "tspan"), this.textElement.appendChild(this.measuringElement), this.result = [] } e.startBatch = function (e, t) { return new n(e, t) } }(o.Factory || (o.Factory = {})), (o.Service || (o.Service = {})).measureMore = function (n, e, t, r) { var o, i = new Set(e); i.delete("\n"); var s = Array.from(i).filter(function (e) { return !n.width.has(e) }); if (0 < s.length) { var a = document.createElementNS(c.SVGNS, "tspan"); (o = a.classList).add.apply(o, l(t)), a.innerHTML = s.join(""), r.appendChild(a), s.forEach(function (e, t) { n.width.set(e, a.getExtentOfChar(t).width) }), a.remove() } return n } }, function (e, t, n) { "use strict"; Object.defineProperty(t, "__esModule", { value: !0 }); var r = n(13); t.Annotator = r.Annotator; var o = n(27), i = n(28), s = n(29), a = { Connection: o.Connection, Label: i.Label, Content: s.Content }; t.Action = a }, function (e, t, n) { "use strict"; var r, o = this && this.__extends || (r = function (e, t) { return (r = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function (e, t) { e.__proto__ = t } || function (e, t) { for (var n in t) t.hasOwnProperty(n) && (e[n] = t[n]) })(e, t) }, function (e, t) { function n() { this.constructor = e } r(e, t), e.prototype = null === t ? Object.create(t) : (n.prototype = t.prototype, new n) }); Object.defineProperty(t, "__esModule", { value: !0 }); var s, i = n(3), a = n(14), l = n(17), c = n(0), u = n(24), h = n(25), d = n(26), f = (s = i.EventEmitter, o(p, s), p.prototype.applyAction = function (e) { e.apply(this.store) }, p.prototype.export = function () { this.view.contentEditor.hide(); var e = this.view.svgElement.outerHTML.replace(/&nbsp;/, " "); return this.view.contentEditor.show(), e }, p.prototype.remove = function () { this.view.svgElement.remove(), this.store.config.contentEditable && this.view.contentEditor.remove() }, p); function p(e, t, n) { var r = s.call(this) || this; r.containerElement = t, r.configInput = n; var o = u.parseInput(n || {}); r.store = new a.Store(o), r.store.json = "string" == typeof e ? JSON.parse(e) : e; var i = document.createElementNS(c.SVGNS, "svg"); return i.setAttribute("xmlns", c.SVGNS), t.appendChild(i), r.view = new l.View(r, i, o), r.textSelectionHandler = new h.TextSelectionHandler(r, o), r.twoLabelsClickedHandler = new d.TwoLabelsClickedHandler(r, o), r } t.Annotator = f }, function (e, t, n) { "use strict"; var r, o = this && this.__extends || (r = function (e, t) { return (r = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function (e, t) { e.__proto__ = t } || function (e, t) { for (var n in t) t.hasOwnProperty(n) && (e[n] = t[n]) })(e, t) }, function (e, t) { function n() { this.constructor = e } r(e, t), e.prototype = null === t ? Object.create(t) : (n.prototype = t.prototype, new n) }); Object.defineProperty(t, "__esModule", { value: !0 }); var i, s = n(15), a = n(8), l = n(16), c = n(9), u = n(3), h = (i = u.EventEmitter, o(d, i), Object.defineProperty(d.prototype, "content", { get: function () { return this._content }, enumerable: !0, configurable: !0 }), Object.defineProperty(d.prototype, "json", { get: function () { return { content: this._content, labelCategories: this.labelCategoryRepo.json, labels: this.labelRepo.json, connectionCategories: this.connectionCategoryRepo.json, connections: this.connectionRepo.json } }, set: function (e) { var t = this; this._content = e.content.endsWith("\n") ? e.content : e.content + "\n", s.LabelCategory.Factory.createAll(e.labelCategories, this.config).map(function (e) { return t.labelCategoryRepo.add(e) }), a.Label.Factory.createAll(e.labels, this).map(function (e) { return t.labelRepo.add(e) }), e.connectionCategories.map(function (e) { return t.connectionCategoryRepo.add(e) }), c.Connection.Factory.createAll(e.connections, this).map(function (e) { return t.connectionRepo.add(e) }) }, enumerable: !0, configurable: !0 }), d.prototype.contentSlice = function (e, t) { return this.content.slice(e, t) }, d.prototype.moveLabels = function (t, n) { Array.from(this.labelRepo.values()).filter(function (e) { return e.startIndex >= t }).map(function (e) { return e.move(n) }) }, d.prototype.spliceContent = function (t, e) { for (var n = [], r = 2; r < arguments.length; r++)n[r - 2] = arguments[r]; var o = t + e; if (0 === e || void 0 === Array.from(this.labelRepo.values()).find(function (e) { return e.startIndex <= t && t < e.endIndex || e.startIndex < o && o < e.endIndex })) { var i = this.content.slice(0, t), s = this.content.slice(t, t + e), a = n.join(""), l = this.content.slice(t + e); this._content = i + a + l, this.moveLabels(t + e, a.length - s.length), this.emit("contentSpliced", t, s, a) } }, d); function d(e) { var t = i.call(this) || this; return t._content = "", t.config = e, t.labelCategoryRepo = new s.LabelCategory.Repository, t.labelRepo = new a.Label.Repository(e), t.connectionCategoryRepo = new l.ConnectionCategory.Repository, t.connectionRepo = new c.Connection.Repository(e), t } t.Store = h }, function (e, t, n) { "use strict"; var r, o = this && this.__extends || (r = function (e, t) { return (r = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function (e, t) { e.__proto__ = t } || function (e, t) { for (var n in t) t.hasOwnProperty(n) && (e[n] = t[n]) })(e, t) }, function (e, t) { function n() { this.constructor = e } r(e, t), e.prototype = null === t ? Object.create(t) : (n.prototype = t.prototype, new n) }); Object.defineProperty(t, "__esModule", { value: !0 }); var i, s, a, l, c = n(1), u = n(5); function h() { return null !== s && s.apply(this, arguments) || this } function d(e, t) { var n = e.borderColor, r = e.color; return !e.borderColor && e["border-color"] && (n = e["border-color"]), e.color || (r = t), e.borderColor || (n = u.shadeColor(r, -30)), { id: e.id, text: e.text, color: r, borderColor: n } } i = t.LabelCategory || (t.LabelCategory = {}), s = c.Base.Repository, o(h, s), l = h, i.Repository = l, (a = i.Factory || (i.Factory = {})).create = d, a.createAll = function (e, t) { return e.map(function (e) { return d(e, t.defaultLabelColor) }) } }, function (e, t, n) { "use strict"; var r, o = this && this.__extends || (r = function (e, t) { return (r = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function (e, t) { e.__proto__ = t } || function (e, t) { for (var n in t) t.hasOwnProperty(n) && (e[n] = t[n]) })(e, t) }, function (e, t) { function n() { this.constructor = e } r(e, t), e.prototype = null === t ? Object.create(t) : (n.prototype = t.prototype, new n) }); Object.defineProperty(t, "__esModule", { value: !0 }); var i, s, a, l = n(1); function c() { return null !== s && s.apply(this, arguments) || this } i = t.ConnectionCategory || (t.ConnectionCategory = {}), s = l.Base.Repository, o(c, s), a = c, i.Repository = a }, function (e, t, n) { "use strict"; var f = this && this.__read || function (e, t) { var n = "function" == typeof Symbol && e[Symbol.iterator]; if (!n) return e; var r, o, i = n.call(e), s = []; try { for (; (void 0 === t || 0 < t--) && !(r = i.next()).done;)s.push(r.value) } catch (e) { o = { error: e } } finally { try { r && !r.done && (n = i.return) && n.call(i) } finally { if (o) throw o.error } } return s }, C = this && this.__spread || function () { for (var e = [], t = 0; t < arguments.length; t++)e = e.concat(f(arguments[t])); return e }, I = this && this.__values || function (e) { var t = "function" == typeof Symbol && Symbol.iterator, n = t && e[t], r = 0; if (n) return n.call(e); if (e && "number" == typeof e.length) return { next: function () { return e && r >= e.length && (e = void 0), { value: e && e[r++], done: !e } } }; throw new TypeError(t ? "Object is not iterable." : "Symbol.iterator is not defined.") }; Object.defineProperty(t, "__esModule", { value: !0 }); var p = n(0), S = n(18), y = n(11), v = n(21), m = n(7), b = n(10), g = n(22), x = n(23), O = n(2), r = (w.layoutTopContextsAfter = function (e) { for (; e.next.isSome;)e.topContext.update(), e = e.next.toNullable(); e.topContext.update() }, w.prototype.constructLabelViewsForLine = function (t) { var n = this, e = this.store.labelRepo.getEntitiesInRange(t.startIndex, t.endIndex).map(function (e) { return new m.LabelView.Entity(e, t.topContext, n.config) }); return e.map(function (e) { return n.labelViewRepository.add(e) }), e.map(function (e) { return t.topContext.addChild(e) }), e }, w.prototype.constructConnectionsForLine = function (n) { var r = this; return this.store.labelRepo.getEntitiesInRange(n.startIndex, n.endIndex).map(function (e) { var t = e.sameLineConnections.filter(function (e) { return !r.connectionViewRepository.has(e.id) }).map(function (e) { return new b.ConnectionView.Entity(e, n.topContext, r.config) }); return t.map(function (e) { return r.connectionViewRepository.add(e) }), t.map(function (e) { return n.topContext.addChild(e) }), t }).reduce(function (e, t) { return e.concat(t) }, []) }, Object.defineProperty(w.prototype, "height", { get: function () { var n = this; return this.lines.reduce(function (e, t) { return e + t.height + n.contentFont.fontSize * (n.config.lineHeight - 1) }, 20) }, enumerable: !0, configurable: !0 }), w.createMarkerElement = function () { var e = document.createElementNS(p.SVGNS, "path"); e.setAttribute("d", "M0,4 L0,8 L6,6 L0,4 L0,8"), e.setAttribute("stroke", "#000000"), e.setAttribute("fill", "#000000"); var t = document.createElementNS(p.SVGNS, "marker"); return t.setAttribute("id", "marker-arrow"), t.setAttribute("markerWidth", "8"), t.setAttribute("markerHeight", "10"), t.setAttribute("orient", "auto"), t.setAttribute("refX", "5"), t.setAttribute("refY", "6"), t.appendChild(e), t }, w.prototype.contentWidth = function (e, t) { return this.contentFont.widthOf(this.store.contentSlice(e, t)) }, w.prototype.removeLine = function (e) { var t = this; e.remove(), e.topContext.children.forEach(function (e) { e instanceof m.LabelView.Entity ? t.labelViewRepository.delete(e) : e instanceof b.ConnectionView.Entity && t.connectionViewRepository.delete(e) }) }, w.prototype.registerEventHandlers = function () { var n = this; this.textElement.onmouseup = function (e) { "Range" === window.getSelection().type ? n.root.textSelectionHandler.textSelected() : n.config.contentEditable && n.contentEditor.caretChanged(e.clientY) }, this.store.labelRepo.on("created", this.onLabelCreated.bind(this)), this.store.labelRepo.on("removed", function (e) { var t = n.labelViewRepository.get(e.id); t.lineIn.topContext.removeChild(t), t.remove(), n.labelViewRepository.delete(t), t.lineIn.topContext.update(), t.lineIn.update(), w.layoutTopContextsAfter(t.lineIn), n.config.contentEditable && n.contentEditor.update() }), this.store.connectionRepo.on("created", this.onConnectionCreated.bind(this)), this.store.connectionRepo.on("removed", function (e) { var t = n.connectionViewRepository.get(e.id); t.lineIn.topContext.removeChild(t), t.remove(), n.connectionViewRepository.delete(t), t.lineIn.topContext.update(), t.lineIn.update(), w.layoutTopContextsAfter(t.lineIn), n.config.contentEditable && n.contentEditor.update() }), this.config.contentEditable && this.store.on("contentSpliced", this.onContentSpliced.bind(this)) }, w.prototype.rerenderLines = function (e, t) { for (var n, r, o, i, s, a, l, c = this.lines[0].svgElement.parentElement, u = e; u <= t; ++u)this.removeLine(this.lines[u]); var h = this.lines[e], d = this.lines[t], f = S.Line.Service.divide(this, h.startIndex, d.endIndex); for (0 !== f.length && (f[0].last = h.last, h.last.map(function (e) { return e.next = O.some(f[0]) }), f[f.length - 1].next = d.next, d.next.map(function (e) { return e.last = O.some(f[f.length - 1]) }), (n = this.lines).splice.apply(n, C([e, t - e + 1], f)), 0 === e ? d.next.isSome ? f[0].insertBefore(d.next) : f[0].insertInto(c) : f[0].insertAfter(h.last)), u = 1; u < f.length; ++u)f[u].insertAfter(O.some(f[u - 1])); function p(t) { y.constructLabelViewsForLine(t).map(function (e) { return t.topContext.renderChild(e) }) } var y = this; try { for (var v = I(f), m = v.next(); !m.done; m = v.next())p(_ = m.value) } catch (e) { r = { error: e } } finally { try { m && !m.done && (o = v.return) && o.call(v) } finally { if (r) throw r.error } } function b(t) { g.constructConnectionsForLine(t).map(function (e) { return t.topContext.renderChild(e) }) } var g = this; try { for (var x = I(f), w = x.next(); !w.done; w = x.next())b(_ = w.value) } catch (e) { i = { error: e } } finally { try { w && !w.done && (s = x.return) && s.call(x) } finally { if (i) throw i.error } } try { for (var E = I(f), L = E.next(); !L.done; L = E.next()) { var _; (_ = L.value).update(), _.topContext.update() } } catch (e) { a = { error: e } } finally { try { L && !L.done && (l = E.return) && l.call(E) } finally { if (a) throw a.error } } }, w.prototype.onLabelCreated = function (e) { var t = f(this.findRangeInLines(e.startIndex, e.endIndex), 2), n = t[0]; if (t[1] === n + 1) { var r = this.lines[n], o = new m.LabelView.Entity(e, r.topContext, this.config); this.labelViewRepository.add(o), r.topContext.addChild(o), r.topContext.renderChild(o), r.topContext.update(), r.update() } else { var i = this.findHardLineEndsInIndex(n); this.rerenderLines(n, i) } w.layoutTopContextsAfter(this.lines[n]), this.config.contentEditable && this.contentEditor.update(), this.svgElement.style.height = this.height.toString() + "px" }, w.prototype.findRangeInLines = function (n, r) { var o = 0, i = 0; return this.lines.forEach(function (e, t) { e.startIndex <= n && n < e.endIndex && (o = t), e.startIndex <= r - 1 && r - 1 < e.endIndex && (i = t + 1) }), [o, i] }, w.prototype.onConnectionCreated = function (e) { var t = this.labelViewRepository.get(e.priorLabel.id), n = t.lineIn.topContext, r = new b.ConnectionView.Entity(e, n, this.config); this.connectionViewRepository.add(r), n.addChild(r), n.renderChild(r), n.update(), t.lineIn.update(), w.layoutTopContextsAfter(t.lineIn), this.config.contentEditable && this.contentEditor.update(), this.svgElement.style.height = this.height.toString() + "px" }, w.prototype.onContentSpliced = function (e, t, n) { "" !== t && this.onRemoved(e, t), "" !== n && this.onInserted(e, n) }, w.prototype.onRemoved = function (e, t) { var n = f(this.findRangeInLines(e, e + 1), 2), r = n[0]; n[1], this.lines[r].startIndex === e - t.length ? this.lines[r].move(-t.length) : this.lines[r].inserted(-t.length); for (var o = r + 1; o < this.lines.length;)this.lines[o].move(-t.length), ++o; var i = this.findHardLineEndsInIndex(r); if ("\n" === t && this.lines[r].isBlank) { var s = this.lines[r].last, a = this.lines[r].next; this.lines[r].remove(), this.lines.splice(r, 1), s.map(function (e) { return e.next = a }), a.map(function (e) { return e.last = s }) } else this.rerenderLines(r, i); w.layoutTopContextsAfter(this.lines[i - 1]); var l = Array.from(t).filter(function (e) { return "\n" === e }).length; 0 === l ? (this.contentEditor.characterIndex -= t.length, this.contentEditor.avoidInLabel("forward")) : 0 <= this.contentEditor.lineIndex - l && (this.contentEditor.lineIndex -= l, this.contentEditor.characterIndex = this.contentEditor.line.content.length, this.contentEditor.avoidInLabel("forward")), this.contentEditor.update(), this.svgElement.style.height = this.height.toString() + "px" }, w.prototype.onInserted = function (e, t) { var n = f(this.findRangeInLines(e, e + 1), 2), r = n[0]; n[1], this.lines[r].startIndex === e + t.length ? this.lines[r].move(t.length) : this.lines[r].inserted(t.length); for (var o = r + 1; o < this.lines.length;)this.lines[o].move(t.length), ++o; var i = this.findHardLineEndsInIndex(r); this.rerenderLines(r, i), w.layoutTopContextsAfter(this.lines[i]); var s = Array.from(t), a = s.filter(function (e) { return "\n" === e }).length, l = s.lastIndexOf("\n"), c = t.length - l; 0 === a ? this.contentEditor.characterIndex += t.length : (this.contentEditor.lineIndex += a, this.contentEditor.characterIndex = c - 1), this.contentEditor.avoidInLabel("forward"), this.contentEditor.update(), this.svgElement.style.height = this.height.toString() + "px" }, w.prototype.findHardLineEndsInIndex = function (e) { var t; for (t = e; t < this.lines.length - 1 && !this.lines[t].endWithHardLineBreak; ++t); return t }, w.prototype.collectStyle = function () { var e = document.createElementNS(p.SVGNS, "style"), t = "\n        " + this.config.contentClasses.map(function (e) { return "." + e }).join(",") + " {\n            font-family: " + this.contentFont.fontFamily + ";\n            font-weight: " + this.contentFont.fontWeight + ";\n            font-size: " + this.contentFont.fontSize + "px;\n            line-height: " + this.contentFont.lineHeight + "px;\n        }\n        ", n = "\n        " + this.config.labelClasses.map(function (e) { return "." + e }).join(",") + " {\n            font-family: " + this.labelFont.fontFamily + ";\n            font-weight: " + this.labelFont.fontWeight + ";\n            font-size: " + this.labelFont.fontSize + "px;\n        }\n        ", r = this.config.connectionClasses.map(function (e) { return "." + e }).join(","), o = this.config.connectionClasses.map(function (e) { return "." + e + "-line" }).join(","), i = "\n        " + r + " {\n            font-family: " + this.connectionFont.fontFamily + ";\n            font-weight: " + this.connectionFont.fontWeight + ";\n            font-size: " + this.connectionFont.fontSize + "px;\n        }\n        " + o + " {\n            stroke: #000;\n        }\n        "; return e.innerHTML = t + n + i, e }, Object.defineProperty(w.prototype, "paddingLeft", { get: function () { var t = this; return Math.max.apply(Math, C(Array.from(this.store.labelCategoryRepo.values()).map(function (e) { return t.labelFont.widthOf(e.text) }))) / 2 + 1 }, enumerable: !0, configurable: !0 }), w); function w(e, t, n) { var r, o, i; this.root = e, this.svgElement = t, this.config = n, this.contentEditor = null, this.store = e.store, this.labelViewRepository = new m.LabelView.Repository, this.connectionViewRepository = new b.ConnectionView.Repository, this.markerElement = w.createMarkerElement(), this.svgElement.appendChild(this.markerElement), this.textElement = document.createElementNS(p.SVGNS, "text"), this.textElement.style.whiteSpace = "pre", this.textElement.style.wordWrap = "normal", this.svgElement.appendChild(this.textElement); var s = Array.from(this.store.labelCategoryRepo.values()).map(function (e) { return e.text }).join(""), a = Array.from(this.store.connectionCategoryRepo.values()).map(function (e) { return e.text }).join(""); r = f(y.Font.Factory.startBatch(t, this.textElement).thanCreate(n.contentClasses, this.store.content).thanCreate(n.labelClasses, s).thanCreate(n.connectionClasses, a).endBatch(), 3), this.contentFont = r[0], this.labelFont = r[1], this.connectionFont = r[2]; var l = this.labelFont.lineHeight + 2 + 2 * n.labelPadding + n.bracketWidth; this.topContextLayerHeight = 2 * n.topContextMargin + Math.max(l, this.connectionFont.lineHeight), (o = this.textElement.classList).add.apply(o, C(n.contentClasses)), this.labelCategoryElementFactoryRepository = new v.LabelCategoryElement.FactoryRepository(this, n), this.connectionCategoryElementFactoryRepository = new g.ConnectionCategoryElement.FactoryRepository(this, n), this.lineMaxWidth = t.width.baseVal.value - 2 * this.paddingLeft, this.lines = S.Line.Service.divide(this, 0, this.store.content.length), this.lines.map(this.constructLabelViewsForLine.bind(this)), this.lines.map(this.constructConnectionsForLine.bind(this)); var c = this.lines.map(function (e) { return e.render() }); if ((i = this.textElement).append.apply(i, C(c)), this.svgElement.style.height = this.height.toString() + "px", this.registerEventHandlers(), this.config.contentEditable) { this.contentEditor = new x.ContentEditor(this); var u = f(this.contentEditor.render(), 2), h = u[0], d = u[1]; this.svgElement.appendChild(h), this.svgElement.parentNode.insertBefore(d, this.svgElement) } this.svgElement.appendChild(this.collectStyle()) } t.View = r }, function (e, t, n) { "use strict"; var i = this && this.__read || function (e, t) { var n = "function" == typeof Symbol && e[Symbol.iterator]; if (!n) return e; var r, o, i = n.call(e), s = []; try { for (; (void 0 === t || 0 < t--) && !(r = i.next()).done;)s.push(r.value) } catch (e) { o = { error: e } } finally { try { r && !r.done && (n = i.return) && n.call(i) } finally { if (o) throw o.error } } return s }, f = this && this.__values || function (e) { var t = "function" == typeof Symbol && Symbol.iterator, n = t && e[t], r = 0; if (n) return n.call(e); if (e && "number" == typeof e.length) return { next: function () { return e && r >= e.length && (e = void 0), { value: e && e[r++], done: !e } } }; throw new TypeError(t ? "Object is not iterable." : "Symbol.iterator is not defined.") }; Object.defineProperty(t, "__esModule", { value: !0 }); var p = n(2), s = n(0), a = n(19), l = n(20); !function (r) { var e = (Object.defineProperty(t.prototype, "startIndex", { get: function () { return this._startIndex }, enumerable: !0, configurable: !0 }), Object.defineProperty(t.prototype, "endIndex", { get: function () { return this._endIndex }, enumerable: !0, configurable: !0 }), t.prototype.move = function (e) { this._startIndex += e, this._endIndex += e }, t.prototype.inserted = function (e) { this._endIndex += e }, Object.defineProperty(t.prototype, "dy", { get: function () { return this.last.match(this.view.contentFont.fontSize * this.config.lineHeight, this.view.contentFont.topToBaseLine) + this.topContext.layer * this.view.topContextLayerHeight }, enumerable: !0, configurable: !0 }), Object.defineProperty(t.prototype, "height", { get: function () { return this.topContext.layer * this.view.topContextLayerHeight + this.view.contentFont.fontSize }, enumerable: !0, configurable: !0 }), Object.defineProperty(t.prototype, "y", { get: function () { var n = this; return l.takeWhile(this.view.lines, function (e) { return e !== n }).reduce(function (e, t) { return e + t.height + n.view.contentFont.fontSize * (n.config.lineHeight - 1) }, 0) + this.topContext.layer * this.view.topContextLayerHeight }, enumerable: !0, configurable: !0 }), Object.defineProperty(t.prototype, "isBlank", { get: function () { return "" === this.view.store.content.slice(this.startIndex, this.endIndex - 1) }, enumerable: !0, configurable: !0 }), Object.defineProperty(t.prototype, "content", { get: function () { return this.endWithHardLineBreak ? this.isBlank ? "" : this.view.store.content.slice(this.startIndex, this.endIndex - 1) : this.view.store.content.slice(this.startIndex, this.endIndex) }, enumerable: !0, configurable: !0 }), Object.defineProperty(t.prototype, "endWithHardLineBreak", { get: function () { return "\n" === this.view.store.content[this.endIndex - 1] }, enumerable: !0, configurable: !0 }), t.prototype.update = function () { this.svgElement.innerHTML = this.content.replace(/ /g, "&nbsp;"), this.isBlank && (this.svgElement.style.fontSize = this.view.contentFont.fontSize / 4 + "px"), this.svgElement.setAttribute("x", this.view.paddingLeft.toString()), this.svgElement.setAttribute("dy", this.dy.toString() + "px") }, t.prototype.render = function () { this.svgElement = document.createElementNS(s.SVGNS, "tspan"); var e = i(this.topContext.render(), 2), t = e[0], n = e[1]; return this.view.svgElement.insertBefore(t, this.view.textElement), this.view.markerElement.insertAdjacentElement("afterend", n), Object.assign(this.svgElement, { annotatorElement: this }), this.update(), this.svgElement }, t.prototype.remove = function () { this.topContext.remove(), this.svgElement.remove() }, t.prototype.insertBefore = function (e) { var t = this; this.render(), e.map(function (e) { e.svgElement.parentNode.insertBefore(t.svgElement, e.svgElement), e.topContext.svgElement.parentNode.insertBefore(t.topContext.svgElement, e.topContext.svgElement), e.topContext.backgroundElement.parentNode.insertBefore(t.topContext.backgroundElement, e.topContext.backgroundElement) }) }, t.prototype.insertAfter = function (e) { var t = this; this.render(), e.map(function (e) { e.svgElement.insertAdjacentElement("afterend", t.svgElement), e.topContext.svgElement.insertAdjacentElement("afterend", t.topContext.svgElement), e.topContext.backgroundElement.insertAdjacentElement("afterend", t.topContext.backgroundElement) }) }, t.prototype.insertInto = function (e) { this.render(), e.appendChild(this.svgElement) }, t); function t(e, t, n, r, o) { this.last = n, this.next = r, this.view = o, this.svgElement = null, this._startIndex = e, this._endIndex = t, this.topContext = new a.TopContext(this), this.config = o.config } r.ValueObject = e; var o = (Object.defineProperty(n.prototype, "store", { get: function () { return this.view.store }, enumerable: !0, configurable: !0 }), n.prototype.divide = function (e, t) { var n, r; this.init(); var o = e, i = e + 1; do { var s = this.mergeLabel(i), a = this.mergeWord(s), l = s === i && s === a; "\n" === this.store.content[i - 1] ? (0 === this.tokenQueue.length ? this.reduce(i - 1, i) : this.reduce(this.tokenQueue[0].startIndex, i), o = i) : l && (this.shiftWithAutoReduce({ startIndex: o, endIndex: i }), o = i), ++i } while (o < t); function c(t) { u.map(function (e) { return e.next = p.some(t) }), t.last = u, u = p.some(t) } 0 !== this.tokenQueue.length && this.reduce(this.tokenQueue[0].startIndex, this.tokenQueue[this.tokenQueue.length - 1].endIndex); var u = p.none; try { for (var h = f(this.result), d = h.next(); !d.done; d = h.next())c(d.value) } catch (e) { n = { error: e } } finally { try { d && !d.done && (r = h.return) && r.call(h) } finally { if (n) throw n.error } } return this.result }, n.prototype.init = function () { this.result = [], this.tokenQueue = [] }, n.prototype.mergeLabel = function (t) { return this.store.labelRepo.getEntitiesCross(t - 1).some(function (e) { return e.endIndex > t }) ? this.store.labelRepo.getEntitiesCross(t - 1).filter(function (e) { return e.endIndex > t }).sort(function (e, t) { return t.endIndex - e.endIndex })[0].endIndex : t }, n.prototype.mergeWord = function (e) { n.wordReg.lastIndex = 0; var t = n.wordReg.exec(this.store.contentSlice(e - 1, e + 1)); return null !== t && 2 === t[0].length ? e + 1 : e }, n.prototype.reduce = function (e, t) { var n = new r.ValueObject(e, t, p.none, p.none, this.view); this.result.push(n), this.tokenQueue = [] }, n.prototype.shiftWithAutoReduce = function (e) { var t = 0 === this.tokenQueue.length ? 0 : this.view.contentWidth(this.tokenQueue[0].startIndex, this.tokenQueue[this.tokenQueue.length - 1].endIndex), n = this.view.contentWidth(e.startIndex, e.endIndex); 0 !== this.tokenQueue.length && t + n > this.view.lineMaxWidth && this.reduce(this.tokenQueue[0].startIndex, this.tokenQueue[this.tokenQueue.length - 1].endIndex), n > this.view.lineMaxWidth ? (this.reduce(e.startIndex, e.endIndex), console.warn('the token "' + this.store.contentSlice(e.startIndex, e.endIndex) + '" is too long for a line!')) : this.tokenQueue.push(e) }, n.wordReg = /([a-zA-z][a-zA-Z0-9']*[-|.]?)|([+\-]?[0-9.][0-9.%]*)/g, n); function n(e) { this.view = e, this.result = [], this.tokenQueue = [] } (r.Service || (r.Service = {})).divide = function (e, t, n) { return new o(e).divide(t, n) } }(t.Line || (t.Line = {})) }, function (e, t, n) { "use strict"; var r = this && this.__read || function (e, t) { var n = "function" == typeof Symbol && e[Symbol.iterator]; if (!n) return e; var r, o, i = n.call(e), s = []; try { for (; (void 0 === t || 0 < t--) && !(r = i.next()).done;)s.push(r.value) } catch (e) { o = { error: e } } finally { try { r && !r.done && (n = i.return) && n.call(i) } finally { if (o) throw o.error } } return s }, o = this && this.__spread || function () { for (var e = [], t = 0; t < arguments.length; t++)e = e.concat(r(arguments[t])); return e }, l = this && this.__values || function (e) { var t = "function" == typeof Symbol && Symbol.iterator, n = t && e[t], r = 0; if (n) return n.call(e); if (e && "number" == typeof e.length) return { next: function () { return e && r >= e.length && (e = void 0), { value: e && e[r++], done: !e } } }; throw new TypeError(t ? "Object is not iterable." : "Symbol.iterator is not defined.") }; Object.defineProperty(t, "__esModule", { value: !0 }); var i = n(0), c = n(6), u = n(10), s = n(4), a = n(7), h = (Object.defineProperty(d.prototype, "layer", { get: function () { return 0 === this.children.size ? 0 : Math.max.apply(Math, o(Array.from(this.children).map(function (e) { return e.layer }))) }, enumerable: !0, configurable: !0 }), d.prototype.update = function () { var r = this; this.children.forEach(function (e) { return e.update() }), Array.from(this.children).filter(function (e) { return e instanceof a.LabelView.Entity }).map(function (n) { n.store.allConnections.forEach(function (e) { if (r.belongTo.view.connectionViewRepository.has(e.id)) { var t = r.belongTo.view.connectionViewRepository.get(e.id); t.mayNotSameLineLabelView === n && t.update() } }) }) }, d.prototype.render = function () { var t = this; return this.svgElement = document.createElementNS(i.SVGNS, "g"), this.backgroundElement = document.createElementNS(i.SVGNS, "g"), this.children.forEach(function (e) { t.renderChild(e) }), this.update(), [this.svgElement, this.backgroundElement] }, d.prototype.addChild = function (e) { var t, n, r = this.layer, o = !1; e instanceof u.ConnectionView.Entity && (e.layer = e.sameLineLabelView.layer); do { ++e.layer, o = !1; try { for (var i = (t = void 0, l(this.children)), s = i.next(); !s.done; s = i.next()) { var a = s.value; if (c.overLaps(e, a)) { o = !0; break } } } catch (e) { t = { error: e } } finally { try { s && !s.done && (n = i.return) && n.call(i) } finally { if (t) throw t.error } } } while (o); return this.children.add(e), this.layer - r }, d.prototype.renderChild = function (e) { s.assert(this.children.has(e)); var t = e.render(); this.svgElement.appendChild(t) }, d.prototype.removeChild = function (e) { s.assert(this.children.has(e)), this.children.delete(e) }, d.prototype.remove = function () { this.svgElement.remove(), this.backgroundElement.remove() }, d); function d(e) { this.backgroundElement = null, this.svgElement = null, this.children = new Set, this.belongTo = e } t.TopContext = h }, function (e, t, n) { "use strict"; Object.defineProperty(t, "__esModule", { value: !0 }); var r = n(2); t.lookup = function (e, t) { return e.length <= t ? r.none : r.some(e[t]) }, t.takeWhile = function (e, t) { var n; for (n = 0; n < e.length && t(e[n]); ++n); return e.slice(0, n) } }, function (e, t, n) { "use strict"; var r, o = this && this.__extends || (r = function (e, t) { return (r = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function (e, t) { e.__proto__ = t } || function (e, t) { for (var n in t) t.hasOwnProperty(n) && (e[n] = t[n]) })(e, t) }, function (e, t) { function n() { this.constructor = e } r(e, t), e.prototype = null === t ? Object.create(t) : (n.prototype = t.prototype, new n) }), l = this && this.__values || function (e) { var t = "function" == typeof Symbol && Symbol.iterator, n = t && e[t], r = 0; if (n) return n.call(e); if (e && "number" == typeof e.length) return { next: function () { return e && r >= e.length && (e = void 0), { value: e && e[r++], done: !e } } }; throw new TypeError(t ? "Object is not iterable." : "Symbol.iterator is not defined.") }; Object.defineProperty(t, "__esModule", { value: !0 }); var i, c, u, s, a = n(1), h = n(0), d = n(5); function f(e, t, n, r) { this.store = e, this.font = t, this.padding = n, this.svgElement = document.createElementNS(h.SVGNS, "g"); var o = document.createElementNS(h.SVGNS, "rect"); o.setAttribute("fill", /^#/g.test(e.color) ? d.addAlpha(e.color, r) : e.color), o.setAttribute("stroke", e.borderColor), o.setAttribute("width", this.width.toString()), o.setAttribute("height", (t.lineHeight + 2 * n).toString()), o.setAttribute("rx", (2 * n).toString()), o.style.cursor = "pointer"; var i = document.createElementNS(h.SVGNS, "text"); i.style.userSelect = "none", i.style.cursor = "pointer", i.innerHTML = e.text, i.setAttribute("dx", n.toString()), i.setAttribute("dy", t.topToBaseLine + n + "px"), this.svgElement.appendChild(o), this.svgElement.appendChild(i) } function p(e, t) { var n, r, o = u.call(this) || this; try { for (var i = l(e.store.labelCategoryRepo.values()), s = i.next(); !s.done; s = i.next()) { var a = s.value; o.add(new c(a, e.labelFont, t.labelPadding, t.labelOpacity)) } } catch (e) { n = { error: e } } finally { try { s && !s.done && (r = i.return) && r.call(i) } finally { if (n) throw n.error } } return o } i = t.LabelCategoryElement || (t.LabelCategoryElement = {}), Object.defineProperty(f.prototype, "width", { get: function () { return this.font.widthOf(this.store.text) + 2 * this.padding }, enumerable: !0, configurable: !0 }), f.prototype.create = function () { return this.svgElement.cloneNode(!0) }, Object.defineProperty(f.prototype, "id", { get: function () { return this.store.id }, enumerable: !0, configurable: !0 }), c = f, u = a.Base.Repository, o(p, u), s = p, i.FactoryRepository = s }, function (e, t, n) { "use strict"; var r, o = this && this.__extends || (r = function (e, t) { return (r = Object.setPrototypeOf || { __proto__: [] } instanceof Array && function (e, t) { e.__proto__ = t } || function (e, t) { for (var n in t) t.hasOwnProperty(n) && (e[n] = t[n]) })(e, t) }, function (e, t) { function n() { this.constructor = e } r(e, t), e.prototype = null === t ? Object.create(t) : (n.prototype = t.prototype, new n) }), i = this && this.__read || function (e, t) { var n = "function" == typeof Symbol && e[Symbol.iterator]; if (!n) return e; var r, o, i = n.call(e), s = []; try { for (; (void 0 === t || 0 < t--) && !(r = i.next()).done;)s.push(r.value) } catch (e) { o = { error: e } } finally { try { r && !r.done && (n = i.return) && n.call(i) } finally { if (o) throw o.error } } return s }, s = this && this.__spread || function () { for (var e = [], t = 0; t < arguments.length; t++)e = e.concat(i(arguments[t])); return e }, l = this && this.__values || function (e) { var t = "function" == typeof Symbol && Symbol.iterator, n = t && e[t], r = 0; if (n) return n.call(e); if (e && "number" == typeof e.length) return { next: function () { return e && r >= e.length && (e = void 0), { value: e && e[r++], done: !e } } }; throw new TypeError(t ? "Object is not iterable." : "Symbol.iterator is not defined.") }; Object.defineProperty(t, "__esModule", { value: !0 }); var a, c, u, h, d = n(1), f = n(0); function p(e, t, n) { var r; this.store = e, this.svgElement = document.createElementNS(f.SVGNS, "g"); var o = document.createElementNS(f.SVGNS, "rect"); o.setAttribute("fill", "#ffffff"), o.setAttribute("width", t.widthOf(e.text).toString()), o.setAttribute("height", t.lineHeight.toString()); var i = document.createElementNS(f.SVGNS, "text"); (r = i.classList).add.apply(r, s(n)), i.innerHTML = e.text, i.setAttribute("dy", t.topToBaseLine + "px"), this.svgElement.appendChild(o), this.svgElement.appendChild(i) } function y(e, t) { var n, r, o = u.call(this) || this; o.config = t; try { for (var i = l(e.store.connectionCategoryRepo.values()), s = i.next(); !s.done; s = i.next()) { var a = s.value; u.prototype.add.call(o, new c(a, e.connectionFont, t.connectionClasses)) } } catch (e) { n = { error: e } } finally { try { s && !s.done && (r = i.return) && r.call(i) } finally { if (n) throw n.error } } return o } a = t.ConnectionCategoryElement || (t.ConnectionCategoryElement = {}), Object.defineProperty(p.prototype, "id", { get: function () { return this.store.id }, enumerable: !0, configurable: !0 }), p.prototype.create = function () { return this.svgElement.cloneNode(!0) }, c = p, u = d.Base.Repository, o(y, u), h = y, a.FactoryRepository = h }, function (e, t, n) { "use strict"; var r = this && this.__read || function (e, t) { var n = "function" == typeof Symbol && e[Symbol.iterator]; if (!n) return e; var r, o, i = n.call(e), s = []; try { for (; (void 0 === t || 0 < t--) && !(r = i.next()).done;)s.push(r.value) } catch (e) { o = { error: e } } finally { try { r && !r.done && (n = i.return) && n.call(i) } finally { if (o) throw o.error } } return s }, o = this && this.__spread || function () { for (var e = [], t = 0; t < arguments.length; t++)e = e.concat(r(arguments[t])); return e }; Object.defineProperty(t, "__esModule", { value: !0 }); var i = n(0), s = n(11), a = n(7), l = (Object.defineProperty(c.prototype, "characterIndex", { get: function () { return this._characterIndex }, set: function (e) { this.view.lines[this._lineIndex].isBlank ? this._characterIndex = 0 : this._characterIndex = e }, enumerable: !0, configurable: !0 }), Object.defineProperty(c.prototype, "lineIndex", { get: function () { return this._lineIndex }, set: function (e) { this._lineIndex = e }, enumerable: !0, configurable: !0 }), Object.defineProperty(c.prototype, "line", { get: function () { return this.view.lines[this.lineIndex] }, enumerable: !0, configurable: !0 }), c.prototype.render = function () { var r = this; return this.constructCaretElement(), this.constructHiddenTextAreaElement(), this.parentSVGYOffset = this.view.svgElement.getBoundingClientRect().top - document.getElementsByTagName("html")[0].getBoundingClientRect().top, this.hiddenTextAreaElement.onkeyup = function (e) { if (!r.inComposition) { switch (e.key) { case "ArrowLeft": 0 === r.characterIndex ? r.line.last.isSome && (--r.lineIndex, r.characterIndex = r.line.content.length) : (--r.characterIndex, r.avoidInLabel("backward")); break; case "ArrowRight": r.characterIndex >= r.line.content.length || r.line.isBlank ? r.line.next.isSome && (++r.lineIndex, r.characterIndex = 0) : (++r.characterIndex, r.avoidInLabel("forward")); break; case "ArrowUp": r.line.last.isSome && --r.lineIndex, r.characterIndex = Math.min(r.characterIndex, r.line.content.length), r.avoidInLabel("forward"); break; case "ArrowDown": r.line.next.isSome && ++r.lineIndex, r.characterIndex = Math.min(r.characterIndex, r.line.content.length), r.avoidInLabel("forward"); break; case "Backspace": var t = r.line.startIndex + r.characterIndex - 1; r.view.root.emit("contentDelete", t, 1); break; default: if ("" !== r.hiddenTextAreaElement.value) { s.Font.Service.measureMore(r.view.contentFont, r.hiddenTextAreaElement.value, r.view.config.contentClasses, r.view.textElement); var n = r.view.lines[r._lineIndex].startIndex + r.characterIndex; r.view.root.emit("contentInput", n, r.hiddenTextAreaElement.value), r.hiddenTextAreaElement.value = "" } }r.update() } }, this.hiddenTextAreaElement.addEventListener("compositionstart", function () { r.inComposition = !0 }), this.hiddenTextAreaElement.addEventListener("compositionend", function () { r.inComposition = !1 }), this.update(), this.hiddenTextAreaElement.style.opacity = "0", [this.cursorElement, this.hiddenTextAreaElement] }, c.prototype.avoidInLabel = function (e) { for (var t = this.line.startIndex + this.characterIndex, n = Array.from(this.line.topContext.children).filter(function (e) { return e instanceof a.LabelView.Entity }), r = n.find(function (e) { return e.store.startIndex <= t - 1 && t < e.store.endIndex }); void 0 !== r;)"forward" === e ? ++this.characterIndex : --this.characterIndex, t = this.line.startIndex + this.characterIndex, r = n.find(function (e) { return e.store.startIndex <= t - 1 && t < e.store.endIndex }) }, c.prototype.update = function () { var e = this.view.paddingLeft + this.view.contentFont.widthOf(this.line.content.slice(0, this.characterIndex)); this.cursorElement.setAttribute("d", "\n            M" + e + "," + this.line.y + "\n            L" + e + "," + (this.line.y + this.view.contentFont.lineHeight) + "\n        "), this.hiddenTextAreaElement.style.top = this.parentSVGYOffset + this.line.y + "px", this.hiddenTextAreaElement.style.left = this.cursorElement.getBoundingClientRect().left + "px" }, c.prototype.caretChanged = function (e) { var t = window.getSelection(); if ("Caret" === t.type) { var n = document.querySelector("svg").getClientRects()[0]; if (null !== t.anchorNode.parentNode) { var r = t.anchorNode.parentNode.getExtentOfChar(0); if (n.top + r.y + this.view.contentFont.lineHeight <= e) { var o = t.anchorNode.parentNode.nextSibling.annotatorElement; this._lineIndex = this.view.lines.indexOf(o), this.characterIndex = 0, this.avoidInLabel("forward") } else o = t.anchorNode.parentNode.annotatorElement, this._lineIndex = this.view.lines.indexOf(o), this.characterIndex = t.anchorOffset, this.avoidInLabel("forward"); this.update(), this.hiddenTextAreaElement.focus({ preventScroll: !0 }) } } }, c.prototype.constructHiddenTextAreaElement = function () { var e; this.hiddenTextAreaElement = document.createElement("textarea"), this.hiddenTextAreaElement.setAttribute("autocorrect", "off"), this.hiddenTextAreaElement.setAttribute("autocapitalize", "off"), this.hiddenTextAreaElement.setAttribute("spellcheck", "false"), (e = this.hiddenTextAreaElement.classList).add.apply(e, o(this.view.config.contentClasses)), this.hiddenTextAreaElement.style.position = "absolute", this.hiddenTextAreaElement.style.padding = "0", this.hiddenTextAreaElement.style.width = "100vw", this.hiddenTextAreaElement.style.height = "1em", this.hiddenTextAreaElement.style.outline = "none", this.hiddenTextAreaElement.style.zIndex = "-1", this.hiddenTextAreaElement.style.borderStyle = "none", this.hiddenTextAreaElement.style.fontFamily = this.view.contentFont.fontFamily, this.hiddenTextAreaElement.style.fontSize = this.view.contentFont.fontSize + "px", this.hiddenTextAreaElement.style.fontWeight = this.view.contentFont.fontWeight, this.hiddenTextAreaElement.style.opacity = "0" }, c.prototype.constructCaretElement = function () { this.cursorElement = document.createElementNS(i.SVGNS, "path"), this.cursorElement.setAttribute("stroke", "#000000"), this.cursorElement.setAttribute("stroke-width", "1.5"), this.cursorElement.style.animationName = "cursor", this.cursorElement.style.animationDuration = "0.75s", this.cursorElement.style.animationTimingFunction = "ease-out", this.cursorElement.style.animationDirection = "alternate", this.cursorElement.style.animationIterationCount = "infinite" }, c.prototype.hide = function () { this.cursorElement.style.display = "none" }, c.prototype.show = function () { this.cursorElement.style.display = "inline" }, c.prototype.remove = function () { this.hiddenTextAreaElement.remove() }, c); function c(e) { this.view = e, this.cursorElement = null, this.hiddenTextAreaElement = null, this.parentSVGYOffset = null; var t = document.getElementsByTagName("head")[0], n = document.createElement("style"); n.innerHTML = "@keyframes cursor { from { opacity: 0; } to { opacity: 1; }  }", t.appendChild(n), this._lineIndex = 0, this._characterIndex = 0, this.inComposition = !1 } t.ContentEditor = l }, function (e, t, n) { "use strict"; Object.defineProperty(t, "__esModule", { value: !0 }); var r = { contentClasses: ["poplar-annotation-content"], labelClasses: ["poplar-annotation-label"], connectionClasses: ["poplar-annotation-connection"], labelPadding: 2, lineHeight: 1.5, topContextMargin: 3, bracketWidth: 8, allowMultipleLabel: "differentCategory", allowMultipleConnection: "differentCategory", labelWidthCalcMethod: "max", connectionWidthCalcMethod: "line", labelOpacity: 90, defaultLabelColor: "#ff9d61", selectingAreaStrip: /[\n ]/, unconnectedLineStyle: "curve", contentEditable: !0 }; t.parseInput = function (e) { var t = {}; for (var n in r) t[n] = void 0 !== e[n] ? e[n] : r[n]; return t } }, function (e, t, n) { "use strict"; var c = this && this.__read || function (e, t) { var n = "function" == typeof Symbol && e[Symbol.iterator]; if (!n) return e; var r, o, i = n.call(e), s = []; try { for (; (void 0 === t || 0 < t--) && !(r = i.next()).done;)s.push(r.value) } catch (e) { o = { error: e } } finally { try { r && !r.done && (n = i.return) && n.call(i) } finally { if (o) throw o.error } } return s }; Object.defineProperty(t, "__esModule", { value: !0 }); var u = n(2), h = n(4), r = (o.prototype.getSelectionInfo = function () { var e, t = this, n = window.getSelection(); h.assert("Range" === n.type); var r, o, i, s, a = null, l = null; try { a = n.anchorNode.parentNode, l = n.focusNode.parentNode } catch (e) { return null } try { if (r = a.annotatorElement, o = l.annotatorElement, r.view !== this.root.view || o.view !== this.root.view) return null; i = r.startIndex + n.anchorOffset, s = o.startIndex + n.focusOffset } catch (e) { return null } return s < i && (e = c([s, i], 2), i = e[0], s = e[1]), u.fromNullable(this.config.selectingAreaStrip).map(function (e) { for (; e.test(t.root.store.content[i]);)++i; for (; e.test(t.root.store.content[s - 1]);)--s }), s <= i ? null : { startIndex: i, endIndex: s } }, o.prototype.textSelected = function () { var e, t = this.getSelectionInfo(); t && this.root.emit("textSelected", t.startIndex, t.endIndex), null !== (e = window.getSelection()) && void 0 !== e && e.removeAllRanges() }, o); function o(e, t) { this.root = e, this.config = t } t.TextSelectionHandler = r }, function (e, t, n) { "use strict"; var r = this && this.__read || function (e, t) { var n = "function" == typeof Symbol && e[Symbol.iterator]; if (!n) return e; var r, o, i = n.call(e), s = []; try { for (; (void 0 === t || 0 < t--) && !(r = i.next()).done;)s.push(r.value) } catch (e) { o = { error: e } } finally { try { r && !r.done && (n = i.return) && n.call(i) } finally { if (o) throw o.error } } return s }, o = this && this.__spread || function () { for (var e = [], t = 0; t < arguments.length; t++)e = e.concat(r(arguments[t])); return e }; Object.defineProperty(t, "__esModule", { value: !0 }); function i(e, u) { var t, h = this; this.root = e, this.config = u, this.lastSelection = a.none, this.svgElement = document.createElementNS(s.SVGNS, "path"), (t = this.svgElement.classList).add.apply(t, o(e.view.config.connectionClasses.map(function (e) { return e + "-line" }))), this.svgElement.setAttribute("fill", "none"), this.svgElement.style.markerEnd = "url(#marker-arrow)", this.root.on("labelClicked", function (e) { h.lastSelection.isSome ? (h.root.emit("twoLabelsClicked", h.lastSelection.toNullable().id, e), h.svgElement.remove(), h.svgElement.setAttribute("d", ""), h.lastSelection = a.none) : (h.lastSelection = a.some(h.root.view.labelViewRepository.get(e)), h.root.view.svgElement.insertBefore(h.svgElement, h.root.view.svgElement.firstChild)) }), this.root.view.svgElement.onmousemove = function (c) { h.lastSelection.map(function (e) { var t = e.labelLeft + 1, n = e.labelRight - 1, r = e.globalY + 1, o = c.clientX - h.root.view.svgElement.getBoundingClientRect().left, i = c.clientY - h.root.view.svgElement.getBoundingClientRect().top, s = (t + n) / 2 < o ? t : n; if ("straight" === u.unconnectedLineStyle) h.svgElement.setAttribute("d", "\n                    M" + s + "," + r + "\n                    L" + o + "," + i + "\n                "); else if ("curve" === u.unconnectedLineStyle) { var a = (t - o) / 4, l = Math.min(r, i) - 20; h.svgElement.setAttribute("d", "\n                        M" + s + "," + r + "\n                        C" + (s - a) + "," + l + "," + (o + a) + "," + l + "," + o + "," + i + "\n                    ") } }) }, this.root.view.svgElement.oncontextmenu = function (e) { h.lastSelection.map(function () { h.svgElement.remove(), h.svgElement.setAttribute("d", ""), h.lastSelection = a.none, e.preventDefault() }) } } var s = n(0), a = n(2); t.TwoLabelsClickedHandler = i }, function (e, t, n) { "use strict"; Object.defineProperty(t, "__esModule", { value: !0 }); var l = n(9); !function (e) { var r = (t.prototype.apply = function (e) { e.connectionRepo.add(new l.Connection.Entity(null, this.categoryId, this.fromId, this.toId, e)) }, t); function t(e, t, n) { this.categoryId = e, this.fromId = t, this.toId = n } e.CreateConnectionAction = r, e.Create = function (e, t, n) { return new r(e, t, n) }; var n = (o.prototype.apply = function (e) { e.connectionRepo.delete(this.id) }, o); function o(e) { this.id = e } function i(e) { return new n(e) } e.DeleteConnectionAction = n, e.Delete = i; var s = (a.prototype.apply = function (e) { var t = e.connectionRepo.get(this.connectionId); i(this.connectionId).apply(e), e.connectionRepo.add(new l.Connection.Entity(this.connectionId, this.categoryId, t.fromId, t.toId, e)) }, a); function a(e, t) { this.connectionId = e, this.categoryId = t } e.UpdateConnectionAction = s, e.Update = function (e, t) { return new s(e, t) } }(t.Connection || (t.Connection = {})) }, function (e, t, n) { "use strict"; var l = this && this.__values || function (e) { var t = "function" == typeof Symbol && Symbol.iterator, n = t && e[t], r = 0; if (n) return n.call(e); if (e && "number" == typeof e.length) return { next: function () { return e && r >= e.length && (e = void 0), { value: e && e[r++], done: !e } } }; throw new TypeError(t ? "Object is not iterable." : "Symbol.iterator is not defined.") }; Object.defineProperty(t, "__esModule", { value: !0 }); var c = n(8); !function (e) { var r = (t.prototype.apply = function (e) { if (e.content.slice(this.startIndex, this.endIndex).includes("\n")) throw Error("Insert label across hard line is not supported now! Please remove the \\n in content first!"); e.labelRepo.add(new c.Label.Entity(null, this.categoryId, this.startIndex, this.endIndex, e)) }, t); function t(e, t, n) { this.categoryId = e, this.startIndex = t, this.endIndex = n } e.CreateLabelAction = r, e.Create = function (e, t, n) { return new r(e, t, n) }; var n = (o.prototype.apply = function (e) { var t, n; try { for (var r = l(e.labelRepo.get(this.id).allConnections), o = r.next(); !o.done; o = r.next()) { var i = o.value; e.connectionRepo.delete(i) } } catch (e) { t = { error: e } } finally { try { o && !o.done && (n = r.return) && n.call(r) } finally { if (t) throw t.error } } e.labelRepo.delete(this.id) }, o); function o(e) { this.id = e } function i(e) { return new n(e) } e.DeleteLabelAction = n, e.Delete = i; var s = (a.prototype.apply = function (t) { var e = t.labelRepo.get(this.labelId), n = e.allConnections; i(this.labelId).apply(t), t.labelRepo.add(new c.Label.Entity(this.labelId, this.categoryId, e.startIndex, e.endIndex, t)), n.forEach(function (e) { return t.connectionRepo.add(e) }) }, a); function a(e, t) { this.labelId = e, this.categoryId = t } e.UpdateLabelAction = s, e.Update = function (e, t) { return new s(e, t) } }(t.Label || (t.Label = {})) }, function (e, t, n) { "use strict"; var r, o; function i(e, t, n) { this.startIndex = e, this.removeLength = t, this.insert = n } Object.defineProperty(t, "__esModule", { value: !0 }), r = t.Content || (t.Content = {}), i.prototype.apply = function (e) { if (!e.config.contentEditable) throw Error("Content edition is not on!"); e.spliceContent(this.startIndex, this.removeLength, this.insert) }, o = i, r.SpliceAction = o, r.Splice = function (e, t, n) { return new o(e, t, n) } }]);